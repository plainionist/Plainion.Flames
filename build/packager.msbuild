<Project DefaultTargets="All" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="12.0">

  <PropertyGroup>
    <ProjectName>Plainion.Flames</ProjectName>

    <BuildMode>Release</BuildMode>
    <BuildPlatform>Any CPU</BuildPlatform>

    <TestAssemblyPattern>*Tests.dll</TestAssemblyPattern>

    <ProjectRoot>$([System.IO.Path]::GetFullPath('..'))</ProjectRoot>
    <ExternRoot>$(ProjectRoot)\extern</ExternRoot>
    <PackageRoot Condition="'$(ReleaseRoot)' == ''">$(ProjectRoot)\bin\$(ProjectName)-$(Version)</PackageRoot>

    <Solution>$(ProjectRoot)/$(ProjectName).sln</Solution>
  </PropertyGroup>

  <ItemGroup Label="TestFiles">
    <TestFile Include="$(PackageRoot)\*.*Tests.*"/>
    <TestFile Include="$(PackageRoot)\*Moq*"/>
    <TestFile Include="$(PackageRoot)\*Nunit*"/>
    <TestFile Include="$(PackageRoot)\*.nunit"/>
    <TestFile Include="$(PackageRoot)\TestResult.xml"/>
  </ItemGroup>

  <ItemGroup Label="TestFolders">
    <TestFolder Include="$(PackageRoot)/TestData"/>
  </ItemGroup>

  <ItemGroup Label="Redist">
    <Redist Include="$(ExternRoot)\license.*"/>
  </ItemGroup>

  <Target Name="CheckEnvironment">
    <Error Condition="'$(Version)' == ''"  Text="Verison not set" />
  </Target>

  <Target Name="Clean">
    <RemoveDir Directories="$(PackageRoot)"/>
  </Target>

  <Target Name="Build">
    <MSBuild Projects="$(Solution)"
             Properties="Configuration=$(BuildMode);Platform=$(BuildPlatform);OutputPath=$(PackageRoot)"
             Targets="Rebuild"
             BuildInParallel="true"/>
  </Target>

  <UsingTask TaskName="DownloadFile" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <Address ParameterType="System.String" Required="true"/>
      <FileName ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Reference Include="System" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
            if ( !File.Exists(FileName) )
            {
                new System.Net.WebClient().DownloadFile(Address, FileName);
            }
        ]]>
      </Code>
    </Task>
  </UsingTask>
  
  <Target Name="Tests">
    <DownloadFile Address="https://github.com/ronin4net/Plainion/releases/download/Plainion.Starter-1.0.0.0/Plainion.Starter.exe" 
                  FileName="$(PackageRoot)\Plainion.Starter.exe" />

    <Exec Command="$(PackageRoot)\Plainion.Starter.exe -TestIt -a $(TestAssemblyPattern)"
          WorkingDirectory="$(PackageRoot)"
          CustomErrorRegularExpression="^\s*\d+\) Test Failure : .*$"/>

  </Target>

  <Target Name="All" DependsOnTargets="CheckEnvironment;Clean;Build">
    <Copy SourceFiles="@(Redist)" DestinationFolder="$(PackageRoot)"/>

    <Delete Files="@(TestFile)"/>
    <RemoveDir Directories="@(TestFolder)"/>
  </Target>
</Project>
